<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Interactive KPI Movers – fixed</title>

  <!-- Tabulator 5.6.2 via jsDelivr -->
  <link  href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.6.2/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.6.2/dist/js/tabulator.min.js"></script>

  <style>
    body{font-family:sans-serif;margin:20px;}
    #summary{margin:12px 0;font-weight:bold}
  </style>
</head>

<body>
<h2>Interactive KPI movers (demo)</h2>

<div id="summary"></div>
<div id="grid"></div>

<script>
/* --- demo data ----------------------------------------------------------- */
const data = [
  {"campaign":"Campaign 1","P1 Cost":12270,"P2 Cost":10466,"P1 Click":1623,"P2 Click":2515},
  {"campaign":"Campaign 2","P1 Cost":5860 ,"P2 Cost":23526,"P1 Click":1371,"P2 Click":2437},
  {"campaign":"Campaign 3","P1 Cost":10390,"P2 Cost":14426,"P1 Click":630 ,"P2 Click":1805},
  {"campaign":"Campaign 4","P1 Cost":10191,"P2 Cost":15578,"P1 Click":1832,"P2 Click":1385},
  {"campaign":"Campaign 5","P1 Cost":10734,"P2 Cost":24423,"P1 Click":1269,"P2 Click":2215},
  {"campaign":"Campaign 6","P1 Cost":11265,"P2 Cost":21636,"P1 Click":843 ,"P2 Click":1955}
];

/* add derived columns (P1 CPC, P2 CPC and contribution) */
data.forEach(r=>{
  r["P1 CPC"] = r["P1 Cost"] / r["P1 Click"];
  r["P2 CPC"] = r["P2 Cost"] / r["P2 Click"];
  r.share_P1   = r["P1 Click"];         // temp – raw clicks, we’ll normalise later
  r.share_P2   = r["P2 Click"];
});

/* normalise shares so they sum to 1 */
const totalP1Click = data.reduce((s,r)=>s+r["P1 Click"],0);
const totalP2Click = data.reduce((s,r)=>s+r["P2 Click"],0);
data.forEach(r=>{
  r.share_P1 /= totalP1Click;
  r.share_P2 /= totalP2Click;
  r.cpc_contribution = (r["P2 CPC"]-r["P1 CPC"]) * r.share_P2;
});

/* Tabulator grid ---------------------------------------------------------- */
const table = new Tabulator("#grid",{
  data,
  layout:"fitColumns",
  columns:[
    {title:"Campaign", field:"campaign", headerFilter:"input"},
    {title:"P1 Cost", field:"P1 Cost", bottomCalc:"sum", formatter:"money"},
    {title:"P1 Click", field:"P1 Click", bottomCalc:"sum"},
    {title:"P1 CPC", field:"P1 CPC", formatter:"money"},
    {title:"P2 Cost", field:"P2 Cost", bottomCalc:"sum", formatter:"money"},
    {title:"P2 Click", field:"P2 Click", bottomCalc:"sum"},
    {title:"P2 CPC", field:"P2 CPC", formatter:"money"},
    {title:"CPC Contr.", field:"cpc_contribution", formatter:"money", bottomCalc:"sum"},
  ],
});

/* KPI bar (re-computes when user filters) -------------------------------- */
function refresh(){
  const rows = table.getData();
  const p1C = rows.reduce((s,r)=>s+r["P1 Cost"],0);
  const p2C = rows.reduce((s,r)=>s+r["P2 Cost"],0);
  const p1K = rows.reduce((s,r)=>s+r["P1 Click"],0);
  const p2K = rows.reduce((s,r)=>s+r["P2 Click"],0);
  const p1Cpc = p1C/(p1K||1);
  const p2Cpc = p2C/(p2K||1);
  document.getElementById("summary").textContent =
    `P1 CPC ${p1Cpc.toFixed(2)} | P2 CPC ${p2Cpc.toFixed(2)} | Δ ${(p2Cpc-p1Cpc).toFixed(2)}`;
}
refresh();
table.on("dataFiltered", refresh);
</script>
</body>
</html>
